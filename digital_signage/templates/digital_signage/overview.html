{# Digital Signage - Main Overview with Tabbed Interface #}
{# Main entry point for Digital Signage module with internal tab navigation #}
{% extends "core/base.html" %}
{% load static %}

{% block title %}Digital Signage - The Grid{% endblock %}

{% block extra_css %}
<style>
    /* Interactive Grid Background */
    .apps-grid-background {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 0;
        pointer-events: none;
    }

    .apps-grid-canvas {
        width: 100%;
        height: 100%;
    }

    /* Main Container */
    .signage-container {
        position: relative;
        z-index: 1;
        max-width: 1400px;
        margin: 0 auto;
        padding: 3rem 1.5rem;
    }

    /* Page Header */
    .page-header {
        margin-bottom: 3rem;
    }

    .page-header h1 {
        font-size: 3.5rem;
        font-weight: 600;
        color: #ffffff;
        margin: 0 0 1rem 0;
        font-family: "Suisse Intl", "Inter", sans-serif;
    }

    .page-subtitle-wrapper {
        display: flex;
        gap: 1.25rem;
        align-items: flex-start;
    }

    .page-subtitle-line {
        position: relative;
        width: 80px;
        height: 24px;
        flex-shrink: 0;
    }

    .page-subtitle-line::before {
        content: "";
        position: absolute;
        background: #ffffff;
        width: 1px;
        height: 100%;
        left: 0;
        top: 0;
    }

    .page-subtitle-line::after {
        content: "";
        position: absolute;
        background: #ffffff;
        height: 1px;
        width: 80px;
        left: 0;
        bottom: 0;
    }

    .page-subtitle-content {
        padding-top: 0.45rem;
    }

    .page-subtitle-text {
        color: #b3b3c2;
        font-size: 1rem;
        line-height: 1.45;
        margin: 0;
        font-family: "Suisse Intl Mono", "Roboto Mono", monospace;
    }

    /* Tab Navigation - Sharp rectangular style */
    .tab-navigation {
        display: flex;
        gap: 0;
        border-bottom: 1px solid var(--color-border);
        margin-bottom: 2rem;
    }

    .tab-button {
        background: transparent;
        color: rgba(255, 255, 255, 0.65);
        border: none;
        border-bottom: 2px solid transparent;
        padding: 1rem 2rem;
        font-size: 0.95rem;
        font-weight: 500;
        font-family: "Suisse Intl Mono", "Roboto Mono", monospace;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        cursor: pointer;
        transition: all 0.15s ease-out;
        position: relative;
    }

    .tab-button:hover {
        color: #ffffff;
        background: rgba(255, 255, 255, 0.03);
    }

    .tab-button.active {
        color: #6434f8;
        border-bottom-color: #6434f8;
    }

    /* Tab Content Panels */
    .tab-panel {
        display: none;
    }

    .tab-panel.active {
        display: block;
    }

    /* Stats Cards Row */
    .stats-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.5rem;
        margin-bottom: 3rem;
    }

    .stat-card {
        background: var(--color-panel-bg);
        border: 1px solid var(--color-border);
        border-radius: 0;
        padding: 2rem;
        transition: border-color 0.15s ease-out;
    }

    .stat-card:hover {
        border-color: rgba(100, 52, 248, 0.5);
    }

    .stat-label {
        color: rgba(255, 255, 255, 0.65);
        font-size: 0.875rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: 0.75rem;
        font-family: "Suisse Intl Mono", "Roboto Mono", monospace;
    }

    .stat-value {
        color: #6434f8;
        font-size: 2.5rem;
        font-weight: 700;
        font-family: "Suisse Intl", "Inter", sans-serif;
        line-height: 1;
    }

    .stat-subvalue {
        color: rgba(255, 255, 255, 0.5);
        font-size: 0.85rem;
        margin-top: 0.5rem;
        font-family: "Suisse Intl Mono", "Roboto Mono", monospace;
    }

    /* Device Cards Grid */
    .devices-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: 1.5rem;
    }

    .device-card {
        background: var(--color-panel-bg);
        border: 1px solid var(--color-border);
        border-radius: 0;
        padding: 2rem;
        transition: border-color 0.15s ease-out, box-shadow 0.15s ease-out;
        cursor: pointer;
        position: relative;
    }

    .device-card:hover {
        border-color: #6434f8;
        border-width: 2px;
        margin: -1px;
        box-shadow: 0 2px 8px rgba(100, 52, 248, 0.15);
    }

    .device-card-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 1rem;
    }

    .device-name {
        font-size: 1.25rem;
        font-weight: 600;
        color: #ffffff;
        margin-bottom: 0.5rem;
        font-family: "Suisse Intl", "Inter", sans-serif;
    }

    .device-status-indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        flex-shrink: 0;
    }

    .device-status-indicator.online {
        background: #00f0ff;
        box-shadow: 0 0 8px rgba(0, 240, 255, 0.6);
    }

    .device-status-indicator.recent {
        background: #ff9500;
        box-shadow: 0 0 8px rgba(255, 149, 0, 0.6);
    }

    .device-status-indicator.offline {
        background: #666666;
    }

    .device-assignment {
        color: #b3b3c2;
        font-size: 0.95rem;
        margin-bottom: 1rem;
        font-family: "Suisse Intl Mono", "Roboto Mono", monospace;
    }

    .device-assignment strong {
        color: #6434f8;
    }

    .device-last-seen {
        color: rgba(255, 255, 255, 0.5);
        font-size: 0.75rem;
        margin-bottom: 1rem;
        font-family: "Suisse Intl Mono", "Roboto Mono", monospace;
    }

    .device-actions {
        display: flex;
        gap: 0.75rem;
    }

    .quick-assign {
        flex: 1;
        background: rgba(255, 255, 255, 0.06);
        border: 1px solid var(--color-border);
        color: #fff;
        padding: 0.5rem 0.75rem;
        border-radius: 0;
        font-family: "Suisse Intl Mono", "Roboto Mono", monospace;
        font-size: 0.85rem;
        cursor: pointer;
        transition: all 0.15s ease-out;
    }

    .quick-assign:focus {
        outline: none;
        border-color: #6434f8;
        box-shadow: 0 0 0 1px #6434f8;
    }

    .quick-assign option {
        background: #1a1a1a;
        color: #ffffff;
        padding: 0.5rem;
    }

    .quick-assign optgroup {
        background: #2a2a2a;
        color: #9B59FF;
        font-weight: bold;
    }

    /* Floating Action Button */
    .fab {
        position: fixed;
        bottom: 2rem;
        right: 2rem;
        width: 60px;
        height: 60px;
        background: #6434f8;
        border: none;
        border-radius: 0;
        color: #ffffff;
        font-size: 1.5rem;
        cursor: pointer;
        box-shadow: 0 4px 16px rgba(100, 52, 248, 0.4);
        transition: all 0.2s ease-out;
        z-index: 100;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .fab:hover {
        background: #7648fa;
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(100, 52, 248, 0.5);
    }

    /* Modal Overlay */
    .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.85);
        z-index: 1000;
        align-items: center;
        justify-content: center;
    }

    .modal-overlay.active {
        display: flex;
    }

    .modal-content {
        background: var(--color-panel-bg);
        border: 1px solid var(--color-border);
        border-radius: 0;
        padding: 3rem;
        max-width: 500px;
        width: 90%;
        position: relative;
    }

    .modal-close {
        position: absolute;
        top: 1rem;
        right: 1rem;
        background: transparent;
        border: none;
        color: rgba(255, 255, 255, 0.65);
        font-size: 1.5rem;
        cursor: pointer;
        transition: color 0.15s ease-out;
    }

    .modal-close:hover {
        color: #ffffff;
    }

    .modal-title {
        font-size: 1.75rem;
        font-weight: 600;
        color: #ffffff;
        margin-bottom: 1.5rem;
        font-family: "Suisse Intl", "Inter", sans-serif;
    }

    .modal-form {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
    }

    .form-group {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .form-label {
        color: rgba(255, 255, 255, 0.65);
        font-size: 0.875rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        font-family: "Suisse Intl Mono", "Roboto Mono", monospace;
    }

    .form-input {
        background: rgba(255, 255, 255, 0.06);
        border: 1px solid var(--color-border);
        color: #fff;
        padding: 0.75rem 1rem;
        border-radius: 0;
        font-family: "Suisse Intl Mono", "Roboto Mono", monospace;
        font-size: 1.25rem;
        letter-spacing: 0.2em;
        text-transform: uppercase;
        text-align: center;
    }

    .form-input::placeholder {
        color: rgba(255, 255, 255, 0.3);
        letter-spacing: normal;
        text-transform: none;
    }

    .form-input:focus {
        outline: none;
        border-color: #00f0ff;
        box-shadow: 0 0 0 1px #00f0ff;
    }

    .form-help {
        color: rgba(255, 255, 255, 0.5);
        font-size: 0.85rem;
        font-family: "Suisse Intl Mono", "Roboto Mono", monospace;
    }

    .btn-primary-grid {
        background: #6434f8;
        color: #ffffff;
        padding: 0.75rem 2rem;
        border: none;
        border-radius: 0;
        font-weight: 500;
        font-size: 0.95rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        font-family: "Suisse Intl Mono", "Roboto Mono", monospace;
        cursor: pointer;
        transition: all 0.15s ease-out;
    }

    .btn-primary-grid:hover {
        background: #7648fa;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(100, 52, 248, 0.4);
    }

    .btn-primary-grid:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    /* Toast Notifications */
    .toast-container {
        position: fixed;
        top: 2rem;
        right: 2rem;
        z-index: 2000;
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .toast {
        background: var(--color-panel-bg);
        border: 1px solid var(--color-border);
        border-radius: 0;
        padding: 1rem 1.5rem;
        min-width: 300px;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.5);
        animation: slideInRight 0.3s ease-out;
    }

    .toast.success {
        border-left: 3px solid #00f0ff;
    }

    .toast.error {
        border-left: 3px solid #ff3b81;
    }

    .toast-message {
        color: #ffffff;
        font-size: 0.95rem;
        font-family: "Suisse Intl Mono", "Roboto Mono", monospace;
    }

    @keyframes slideInRight {
        from {
            transform: translateX(400px);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }

    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 4rem 2rem;
        color: rgba(255, 255, 255, 0.65);
    }

    .empty-state h3 {
        color: #ffffff;
        font-size: 1.5rem;
        margin-bottom: 1rem;
        font-family: "Suisse Intl", "Inter", sans-serif;
    }

    .empty-state p {
        font-family: "Suisse Intl Mono", "Roboto Mono", monospace;
    }

    /* Device Group Sections */
    .device-group-section {
        background: rgba(255, 255, 255, 0.02);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 4px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }

    .device-group-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }

    .device-group-count {
        color: rgba(255, 255, 255, 0.4);
        font-size: 0.8rem;
        font-family: "Suisse Intl Mono", monospace;
    }

    /* Draggable Device Cards */
    .draggable-device {
        position: relative;
        cursor: pointer;
        transition: transform 0.15s ease, box-shadow 0.15s ease;
    }

    .draggable-device:hover {
        transform: translateY(-2px);
    }

    .draggable-device.dragging {
        opacity: 0.5;
        transform: scale(0.98);
    }

    .drag-handle {
        position: absolute;
        top: 0.75rem;
        right: 0.75rem;
        color: rgba(255, 255, 255, 0.25);
        cursor: grab;
        padding: 0.25rem;
        z-index: 10;
    }

    .drag-handle:hover {
        color: rgba(255, 255, 255, 0.5);
    }

    .drag-handle:active {
        cursor: grabbing;
    }

    /* Drop Zone Styles */
    .device-dropzone {
        min-height: 100px;
        transition: background-color 0.2s ease, border-color 0.2s ease;
    }

    .device-dropzone.drag-over {
        background: rgba(100, 52, 248, 0.1);
        border: 2px dashed #6434f8;
        border-radius: 4px;
    }

    .dropzone-placeholder {
        grid-column: 1 / -1;
        text-align: center;
        padding: 2rem;
        color: rgba(255, 255, 255, 0.3);
        font-family: "Suisse Intl Mono", monospace;
        font-size: 0.875rem;
        border: 1px dashed rgba(255, 255, 255, 0.15);
        border-radius: 4px;
    }

    .device-dropzone.drag-over .dropzone-placeholder {
        color: #6434f8;
        border-color: #6434f8;
    }

    /* Media Library Styles */
    .folder-filter-btn {
        background: transparent;
        border: 1px solid var(--color-border);
        color: rgba(255, 255, 255, 0.65);
        padding: 0.5rem 1rem;
        font-size: 0.8rem;
        font-family: "Suisse Intl Mono", "Roboto Mono", monospace;
        text-transform: uppercase;
        cursor: pointer;
        transition: all 0.15s ease-out;
    }

    .folder-filter-btn:hover {
        border-color: #6434f8;
        color: #ffffff;
    }

    .folder-filter-btn.active {
        background: #6434f8;
        border-color: #6434f8;
        color: #ffffff;
    }

    .media-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
        gap: 1.5rem;
    }

    .media-card {
        background: var(--color-panel-bg);
        border: 1px solid var(--color-border);
        border-radius: 0;
        overflow: hidden;
        cursor: pointer;
        transition: all 0.15s ease-out;
    }

    .media-card:hover {
        border-color: #6434f8;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(100, 52, 248, 0.2);
    }

    .media-thumbnail {
        aspect-ratio: 16/9;
        background: #0a0a0f;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
    }

    .media-thumbnail img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .video-thumbnail {
        position: relative;
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .video-thumbnail img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .video-icon {
        color: rgba(255, 255, 255, 0.5);
    }

    .video-badge {
        position: absolute;
        bottom: 0.5rem;
        right: 0.5rem;
        background: rgba(100, 52, 248, 0.9);
        color: #ffffff;
        padding: 0.25rem 0.5rem;
        font-size: 0.65rem;
        font-family: "Suisse Intl Mono", monospace;
        text-transform: uppercase;
    }

    .media-info {
        padding: 1rem;
    }

    .media-name {
        color: #ffffff;
        font-size: 0.95rem;
        font-weight: 500;
        margin-bottom: 0.5rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .media-meta {
        display: flex;
        gap: 0.75rem;
        color: rgba(255, 255, 255, 0.5);
        font-size: 0.75rem;
        font-family: "Suisse Intl Mono", monospace;
    }

    /* Upload Modal Styles */
    .upload-dropzone {
        border: 2px dashed var(--color-border);
        padding: 3rem;
        text-align: center;
        cursor: pointer;
        transition: all 0.15s ease-out;
        margin-bottom: 1.5rem;
    }

    .upload-dropzone:hover,
    .upload-dropzone.dragover {
        border-color: #6434f8;
        background: rgba(100, 52, 248, 0.05);
    }

    .upload-dropzone-icon {
        font-size: 3rem;
        color: rgba(255, 255, 255, 0.3);
        margin-bottom: 1rem;
    }

    .upload-dropzone-text {
        color: rgba(255, 255, 255, 0.65);
        font-family: "Suisse Intl Mono", monospace;
        font-size: 0.9rem;
    }

    .upload-dropzone-text strong {
        color: #6434f8;
    }

    .upload-preview-list {
        max-height: 200px;
        overflow-y: auto;
        margin-bottom: 1.5rem;
    }

    .upload-preview-item {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 0.75rem;
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid var(--color-border);
        margin-bottom: 0.5rem;
    }

    .upload-preview-thumb {
        width: 60px;
        height: 40px;
        background: #0a0a0f;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
    }

    .upload-preview-thumb img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .upload-preview-info {
        flex: 1;
        min-width: 0;
    }

    .upload-preview-name {
        color: #ffffff;
        font-size: 0.85rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .upload-preview-size {
        color: rgba(255, 255, 255, 0.5);
        font-size: 0.75rem;
        font-family: "Suisse Intl Mono", monospace;
    }

    .upload-preview-remove {
        background: transparent;
        border: none;
        color: rgba(255, 255, 255, 0.5);
        cursor: pointer;
        padding: 0.5rem;
        transition: color 0.15s;
    }

    .upload-preview-remove:hover {
        color: #ff3b81;
    }

    /* Responsive */
    @media (max-width: 768px) {
        .page-header h1 {
            font-size: 2rem;
        }

        .tab-button {
            padding: 0.75rem 1rem;
            font-size: 0.85rem;
        }

        .devices-grid {
            grid-template-columns: 1fr;
        }

        .media-grid {
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
        }

        .fab {
            bottom: 1rem;
            right: 1rem;
            width: 50px;
            height: 50px;
            font-size: 1.25rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Full-width interactive grid background -->
<div class="apps-grid-background">
    <canvas class="apps-grid-canvas"></canvas>
</div>

<div class="signage-container">
    <!-- Page Header -->
    <div class="page-header">
        <h1>Digital Signage</h1>
        <div class="page-subtitle-wrapper">
            <div class="page-subtitle-line"></div>
            <div class="page-subtitle-content">
                <p class="page-subtitle-text">
                    Manage screen designs, playlists, and devices for digital signage displays across all locations.
                </p>
            </div>
        </div>
    </div>

    <!-- Tab Navigation -->
    <div class="tab-navigation">
        <button class="tab-button active" data-tab="overview">Overview</button>
        <button class="tab-button" data-tab="designs">Screen Designs</button>
        <button class="tab-button" data-tab="playlists">Playlists</button>
        <button class="tab-button" data-tab="media">Media</button>
        <button class="tab-button" data-tab="devices">Devices</button>
    </div>

    <!-- TAB 1: Overview -->
    <div class="tab-panel active" id="tab-overview">
        <!-- Stats Cards -->
        <div class="stats-row">
            <div class="stat-card">
                <div class="stat-label">Total Designs</div>
                <div class="stat-value">{{ stats.total_designs|default:0 }}</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Active Devices</div>
                <div class="stat-value">{{ stats.devices_online|default:0 }}</div>
                <div class="stat-subvalue">{{ stats.devices_recent|default:0 }} recent / {{ stats.devices_offline|default:0 }} offline</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Total Playlists</div>
                <div class="stat-value">{{ stats.total_playlists|default:0 }}</div>
            </div>
        </div>

        <!-- Device Cards -->
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <h2 style="color: #ffffff; font-size: 1.5rem; margin: 0; font-family: 'Suisse Intl', 'Inter', sans-serif;">Active Devices</h2>
            <p style="color: rgba(255,255,255,0.5); font-size: 0.8rem; margin: 0; font-family: 'Suisse Intl Mono', monospace;">
                Drag devices between groups to organize
            </p>
        </div>
        {% if devices or device_groups %}
            <!-- Ungrouped Devices Section -->
            <div class="device-group-section" data-group-id="" data-group-slug="">
                <div class="device-group-header">
                    <h3 style="color: rgba(255,255,255,0.7); font-size: 1rem; margin: 0; font-family: 'Suisse Intl Mono', monospace;">
                        Ungrouped Devices
                    </h3>
                    <span class="device-group-count">{{ ungrouped_count }} device{{ ungrouped_count|pluralize }}</span>
                </div>
                <div class="devices-grid device-dropzone" data-group-id="">
                    {% for device in devices %}
                        {% if not device.group %}
                            {% include 'digital_signage/_device_card_draggable.html' with device=device %}
                        {% endif %}
                    {% empty %}
                        <div class="dropzone-placeholder">Drop devices here</div>
                    {% endfor %}
                </div>
            </div>

            <!-- Group Sections -->
            {% for group in device_groups %}
                <div class="device-group-section" data-group-id="{{ group.id }}" data-group-slug="{{ group.slug }}">
                    <div class="device-group-header">
                        <h3 style="color: #6434f8; font-size: 1rem; margin: 0; font-family: 'Suisse Intl Mono', monospace;">
                            {{ group.name }}
                        </h3>
                        <span class="device-group-count">{{ group.device_count }} device{{ group.device_count|pluralize }}</span>
                    </div>
                    {% if group.description %}
                        <p style="color: rgba(255,255,255,0.4); font-size: 0.8rem; margin: 0 0 1rem 0;">{{ group.description }}</p>
                    {% endif %}
                    <div class="devices-grid device-dropzone" data-group-id="{{ group.id }}">
                        {% for device in devices %}
                            {% if device.group == group %}
                                {% include 'digital_signage/_device_card_draggable.html' with device=device %}
                            {% endif %}
                        {% empty %}
                            <div class="dropzone-placeholder">Drop devices here</div>
                        {% endfor %}
                    </div>
                </div>
            {% endfor %}
        {% else %}
            <div class="empty-state">
                <h3>No devices registered</h3>
                <p>Add your first device to start displaying content.</p>
            </div>
        {% endif %}
    </div>

    <!-- TAB 2: Screen Designs -->
    <div class="tab-panel" id="tab-designs">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
            <h2 style="color: #ffffff; font-size: 1.5rem; margin: 0; font-family: 'Suisse Intl', 'Inter', sans-serif;">Screen Designs</h2>
            <a href="{% url 'digital_signage:screen_design_create' %}" class="btn-primary-grid">+ New Design</a>
        </div>

        {% if designs %}
            <div class="devices-grid">
                {% for design in designs %}
                    <div class="device-card" onclick="window.location.href='{% url 'digital_signage:screen_design_edit' design.slug %}'">
                        <div class="device-card-header">
                            <div>
                                <div class="device-name">{{ design.name }}</div>
                                <div style="font-family: 'Suisse Intl Mono', monospace; font-size: 0.875rem; color: #6434f8;">/{{ design.slug }}</div>
                            </div>
                            <span style="padding: 0.25rem 0.75rem; background: {% if design.is_active %}rgba(0,240,255,0.1){% else %}rgba(128,128,128,0.1){% endif %}; border: 1px solid {% if design.is_active %}rgba(0,240,255,0.3){% else %}rgba(128,128,128,0.3){% endif %}; color: {% if design.is_active %}#00f0ff{% else %}#888{% endif %}; font-size: 0.75rem; text-transform: uppercase; font-family: 'Suisse Intl Mono', monospace;">
                                {% if design.is_active %}Active{% else %}Inactive{% endif %}
                            </span>
                        </div>
                        <p class="device-assignment">{{ design.description|truncatewords:15|default:"No description" }}</p>
                        <div class="device-last-seen">Updated {{ design.updated_at|timesince }} ago</div>
                        <div class="device-actions" onclick="event.stopPropagation()">
                            <a href="{% url 'digital_signage:screen_design_edit' design.slug %}" style="flex: 1; padding: 0.5rem 1rem; background: rgba(100,52,248,0.1); color: #6434f8; border: 1px solid rgba(100,52,248,0.3); text-align: center; text-decoration: none; font-size: 0.85rem; text-transform: uppercase; font-family: 'Suisse Intl Mono', monospace;">Edit</a>
                            <a href="{% url 'digital_signage:screen_design_preview' design.slug %}" target="_blank" style="flex: 1; padding: 0.5rem 1rem; background: rgba(0,240,255,0.1); color: #00f0ff; border: 1px solid rgba(0,240,255,0.3); text-align: center; text-decoration: none; font-size: 0.85rem; text-transform: uppercase; font-family: 'Suisse Intl Mono', monospace;">Preview</a>
                            <a href="{% url 'digital_signage:screen_design_delete' design.slug %}" style="padding: 0.5rem 1rem; background: rgba(220,53,69,0.1); color: #dc3545; border: 1px solid rgba(220,53,69,0.3); text-align: center; text-decoration: none; font-size: 0.85rem; text-transform: uppercase; font-family: 'Suisse Intl Mono', monospace;">Delete</a>
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="empty-state">
                <h3>No screen designs yet</h3>
                <p>Create your first screen design to get started.</p>
                <a href="{% url 'digital_signage:screen_design_create' %}" class="btn-primary-grid" style="margin-top: 1rem; display: inline-block;">+ Create First Design</a>
            </div>
        {% endif %}
    </div>

    <!-- TAB 3: Playlists -->
    <div class="tab-panel" id="tab-playlists">
        {% include 'digital_signage/_playlist_list.html' %}
    </div>

    <!-- TAB 4: Media Library -->
    <div class="tab-panel" id="tab-media">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
            <h2 style="color: #ffffff; font-size: 1.5rem; margin: 0; font-family: 'Suisse Intl', 'Inter', sans-serif;">Media Library</h2>
            <div style="display: flex; gap: 1rem;">
                <button class="btn-primary-grid" onclick="openCreateFolderModal()" style="background: transparent; border: 1px solid #6434f8; color: #6434f8;">+ New Folder</button>
                <button class="btn-primary-grid" onclick="openUploadMediaModal()">+ Upload Media</button>
            </div>
        </div>

        <!-- Folder Filter -->
        <div style="margin-bottom: 2rem; display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
            <span style="color: rgba(255,255,255,0.65); font-size: 0.875rem; font-family: 'Suisse Intl Mono', monospace;">FOLDER:</span>
            <button class="folder-filter-btn {% if not current_folder %}active{% endif %}" data-folder="" onclick="filterByFolder('')">All Media</button>
            <button class="folder-filter-btn {% if current_folder == 'uncategorized' %}active{% endif %}" data-folder="uncategorized" onclick="filterByFolder('uncategorized')">Uncategorized</button>
            {% for folder in media_folders %}
                <button class="folder-filter-btn {% if current_folder == folder.slug %}active{% endif %}" data-folder="{{ folder.slug }}" onclick="filterByFolder('{{ folder.slug }}')">{{ folder.name }}</button>
            {% endfor %}
        </div>

        <!-- Media Stats -->
        <div class="stats-row" style="margin-bottom: 2rem;">
            <div class="stat-card">
                <div class="stat-label">Total Media</div>
                <div class="stat-value">{{ media_stats.total|default:0 }}</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Images</div>
                <div class="stat-value">{{ media_stats.images|default:0 }}</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Videos</div>
                <div class="stat-value">{{ media_stats.videos|default:0 }}</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Folders</div>
                <div class="stat-value">{{ media_folders|length|default:0 }}</div>
            </div>
        </div>

        <!-- Media Grid -->
        {% if media_assets %}
            <div class="media-grid">
                {% for asset in media_assets %}
                    <div class="media-card" data-asset-id="{{ asset.id }}" data-folder="{{ asset.folder.slug|default:'uncategorized' }}" onclick="openMediaDetailModal('{{ asset.id }}')">
                        <div class="media-thumbnail">
                            {% if asset.asset_type == 'image' %}
                                <img src="{{ asset.file.url }}" alt="{{ asset.name }}" loading="lazy">
                            {% else %}
                                <div class="video-thumbnail">
                                    {% if asset.thumbnail %}
                                        <img src="{{ asset.thumbnail.url }}" alt="{{ asset.name }}" loading="lazy">
                                    {% else %}
                                        <div class="video-icon">
                                            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                                <polygon points="5 3 19 12 5 21 5 3"></polygon>
                                            </svg>
                                        </div>
                                    {% endif %}
                                    <div class="video-badge">VIDEO</div>
                                </div>
                            {% endif %}
                        </div>
                        <div class="media-info">
                            <div class="media-name">{{ asset.name }}</div>
                            <div class="media-meta">
                                <span>{{ asset.file_extension|upper }}</span>
                                {% if asset.asset_type == 'video' and asset.duration_seconds %}
                                    <span>{{ asset.duration_seconds }}s</span>
                                {% endif %}
                                <span>{{ asset.file_size_display }}</span>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="empty-state">
                <h3>No media uploaded yet</h3>
                <p>Upload images and videos to use in your playlists.</p>
                <button class="btn-primary-grid" style="margin-top: 1rem;" onclick="openUploadMediaModal()">+ Upload First Media</button>
            </div>
        {% endif %}
    </div>

    <!-- TAB 5: Devices -->
    <div class="tab-panel" id="tab-devices">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
            <h2 style="color: #ffffff; font-size: 1.5rem; margin: 0; font-family: 'Suisse Intl', 'Inter', sans-serif;">All Devices</h2>
            <div style="display: flex; gap: 1rem;">
                <button class="btn-primary-grid" onclick="openCreateGroupModal()" style="background: transparent; border: 1px solid #6434f8; color: #6434f8;">+ New Group</button>
                <button class="btn-primary-grid" onclick="openAddDeviceModal()">+ Add Device</button>
            </div>
        </div>

        <p style="color: rgba(255,255,255,0.5); font-size: 0.875rem; margin-bottom: 1.5rem; font-family: 'Suisse Intl Mono', monospace;">
            Drag and drop devices between groups to organize them
        </p>

        {% if devices or device_groups %}
            <!-- Ungrouped Devices Section -->
            <div class="device-group-section" data-group-id="" data-group-slug="">
                <div class="device-group-header">
                    <h3 style="color: rgba(255,255,255,0.7); font-size: 1rem; margin: 0; font-family: 'Suisse Intl Mono', monospace;">
                        Ungrouped Devices
                    </h3>
                    <span class="device-group-count">{{ ungrouped_count }} device{{ ungrouped_count|pluralize }}</span>
                </div>
                <div class="devices-grid device-dropzone" data-group-id="">
                    {% for device in devices %}
                        {% if not device.group %}
                            {% include 'digital_signage/_device_card_draggable.html' with device=device %}
                        {% endif %}
                    {% empty %}
                        <div class="dropzone-placeholder">Drop devices here</div>
                    {% endfor %}
                </div>
            </div>

            <!-- Group Sections -->
            {% for group in device_groups %}
                <div class="device-group-section" data-group-id="{{ group.id }}" data-group-slug="{{ group.slug }}">
                    <div class="device-group-header">
                        <h3 style="color: #6434f8; font-size: 1rem; margin: 0; font-family: 'Suisse Intl Mono', monospace;">
                            {{ group.name }}
                        </h3>
                        <span class="device-group-count">{{ group.device_count }} device{{ group.device_count|pluralize }}</span>
                    </div>
                    {% if group.description %}
                        <p style="color: rgba(255,255,255,0.4); font-size: 0.8rem; margin: 0 0 1rem 0;">{{ group.description }}</p>
                    {% endif %}
                    <div class="devices-grid device-dropzone" data-group-id="{{ group.id }}">
                        {% for device in devices %}
                            {% if device.group == group %}
                                {% include 'digital_signage/_device_card_draggable.html' with device=device %}
                            {% endif %}
                        {% empty %}
                            <div class="dropzone-placeholder">Drop devices here</div>
                        {% endfor %}
                    </div>
                </div>
            {% endfor %}
        {% else %}
            <div class="empty-state">
                <h3>No devices registered</h3>
                <p>Add your first device to start displaying content.</p>
                <button class="btn-primary-grid" style="margin-top: 1rem;" onclick="openAddDeviceModal()">+ Add First Device</button>
            </div>
        {% endif %}
    </div>
</div>

<!-- Floating Action Button (shows on Overview tab) -->
<button class="fab" id="fabButton" onclick="openAddDeviceModal()">+</button>

<!-- Add Device Modal -->
{% include 'digital_signage/_add_device_modal.html' %}

<!-- Upload Media Modal -->
<div class="modal-overlay" id="uploadMediaModal">
    <div class="modal-content" style="max-width: 600px;">
        <button class="modal-close" onclick="closeUploadMediaModal()">&times;</button>
        <h3 class="modal-title">Upload Media</h3>
        <form id="uploadMediaForm" enctype="multipart/form-data">
            {% csrf_token %}
            <div class="upload-dropzone" id="uploadDropzone">
                <div class="upload-dropzone-icon">üìÅ</div>
                <div class="upload-dropzone-text">
                    Drag & drop files here or <strong>click to browse</strong><br>
                    <small style="color: rgba(255,255,255,0.4);">JPG, PNG, GIF, WebP, MP4, WebM (max 100MB)</small>
                </div>
                <input type="file" id="mediaFileInput" name="files" multiple accept="image/*,video/*" style="display: none;">
            </div>

            <div class="upload-preview-list" id="uploadPreviewList" style="display: none;"></div>

            <div class="form-group">
                <label class="form-label">Folder (Optional)</label>
                <select name="folder" class="quick-assign" style="width: 100%;">
                    <option value="">No folder (Uncategorized)</option>
                    {% for folder in media_folders %}
                        <option value="{{ folder.id }}">{{ folder.name }}</option>
                    {% endfor %}
                </select>
            </div>

            <button type="submit" class="btn-primary-grid" style="width: 100%; margin-top: 1rem;" id="uploadSubmitBtn" disabled>
                Upload Files
            </button>
        </form>
    </div>
</div>

<!-- Create Folder Modal -->
<div class="modal-overlay" id="createFolderModal">
    <div class="modal-content">
        <button class="modal-close" onclick="closeCreateFolderModal()">&times;</button>
        <h3 class="modal-title">Create Folder</h3>
        <form id="createFolderForm">
            {% csrf_token %}
            <div class="form-group">
                <label class="form-label">Folder Name</label>
                <input type="text" name="name" class="form-input" style="letter-spacing: normal; text-transform: none; text-align: left;" placeholder="e.g., Store Promotions" required>
            </div>
            <div class="form-group">
                <label class="form-label">Description (Optional)</label>
                <textarea name="description" class="form-input" style="letter-spacing: normal; text-transform: none; text-align: left; min-height: 80px; resize: vertical;" placeholder="What will this folder contain?"></textarea>
            </div>
            <button type="submit" class="btn-primary-grid" style="width: 100%; margin-top: 1rem;">
                Create Folder
            </button>
        </form>
    </div>
</div>

<!-- Create Device Group Modal -->
<div class="modal-overlay" id="createGroupModal">
    <div class="modal-content">
        <button class="modal-close" onclick="closeCreateGroupModal()">&times;</button>
        <h3 class="modal-title">Create Device Group</h3>
        <form id="createGroupForm">
            {% csrf_token %}
            <div class="form-group">
                <label class="form-label">Group Name</label>
                <input type="text" name="name" class="form-input" style="letter-spacing: normal; text-transform: none; text-align: left;" placeholder="e.g., Store 12, Head Office" required>
            </div>
            <div class="form-group">
                <label class="form-label">Description (Optional)</label>
                <textarea name="description" class="form-input" style="letter-spacing: normal; text-transform: none; text-align: left; min-height: 80px; resize: vertical;" placeholder="Notes about this location"></textarea>
            </div>
            <div class="form-group">
                <label class="form-label">Address (Optional)</label>
                <input type="text" name="address" class="form-input" style="letter-spacing: normal; text-transform: none; text-align: left;" placeholder="Physical address">
            </div>
            <button type="submit" class="btn-primary-grid" style="width: 100%; margin-top: 1rem;">
                Create Group
            </button>
        </form>
    </div>
</div>

<!-- Media Detail Modal -->
<div class="modal-overlay" id="mediaDetailModal">
    <div class="modal-content" style="max-width: 700px;">
        <button class="modal-close" onclick="closeMediaDetailModal()">&times;</button>
        <h3 class="modal-title" id="mediaDetailTitle">Media Details</h3>

        <div id="mediaDetailContent">
            <!-- Preview -->
            <div id="mediaPreviewContainer" style="margin-bottom: 1.5rem; border-radius: 8px; overflow: hidden; background: rgba(0,0,0,0.3);">
                <img id="mediaPreviewImage" style="width: 100%; max-height: 300px; object-fit: contain; display: none;">
                <video id="mediaPreviewVideo" style="width: 100%; max-height: 300px; display: none;" controls></video>
            </div>

            <!-- Info -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
                <div>
                    <div class="form-label" style="font-size: 0.75rem;">Type</div>
                    <div id="mediaDetailType" style="color: #fff;">-</div>
                </div>
                <div>
                    <div class="form-label" style="font-size: 0.75rem;">Size</div>
                    <div id="mediaDetailSize" style="color: #fff;">-</div>
                </div>
            </div>

            <!-- Editable fields -->
            <div class="form-group">
                <label class="form-label">Name</label>
                <input type="text" id="mediaDetailName" class="form-input" style="letter-spacing: normal; text-transform: none; text-align: left;">
            </div>

            <div class="form-group">
                <label class="form-label">Folder</label>
                <select id="mediaDetailFolder" class="quick-assign" style="width: 100%;">
                    <option value="">Uncategorized</option>
                    {% for folder in media_folders %}
                        <option value="{{ folder.id }}">{{ folder.name }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Actions -->
            <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                <button type="button" class="btn-primary-grid" style="flex: 1;" onclick="saveMediaChanges()">
                    Save Changes
                </button>
                <button type="button" class="btn-primary-grid" style="background: transparent; border: 1px solid #dc3545; color: #dc3545;" onclick="confirmDeleteMedia()">
                    Delete
                </button>
            </div>
        </div>

        <!-- Loading state -->
        <div id="mediaDetailLoading" style="display: none; text-align: center; padding: 3rem;">
            <div style="color: rgba(255,255,255,0.6);">Loading...</div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal-overlay" id="deleteMediaModal">
    <div class="modal-content" style="max-width: 400px;">
        <button class="modal-close" onclick="closeDeleteMediaModal()">&times;</button>
        <h3 class="modal-title">Delete Media</h3>
        <p style="color: rgba(255,255,255,0.7); margin-bottom: 1.5rem;">
            Are you sure you want to delete "<span id="deleteMediaName"></span>"? This action cannot be undone.
        </p>
        <!-- Error message display -->
        <div id="deleteMediaError" style="display: none; background: rgba(220,53,69,0.15); border: 1px solid rgba(220,53,69,0.5); border-radius: 4px; padding: 1rem; margin-bottom: 1.5rem; color: #ff6b8a;"></div>
        <div style="display: flex; gap: 1rem;">
            <button type="button" class="btn-primary-grid" style="flex: 1; background: transparent; border: 1px solid rgba(255,255,255,0.3); color: rgba(255,255,255,0.7);" onclick="closeDeleteMediaModal()">
                Cancel
            </button>
            <button type="button" class="btn-primary-grid" id="deleteMediaBtn" style="flex: 1; background: #dc3545; border-color: #dc3545;" onclick="executeDeleteMedia()">
                Delete
            </button>
        </div>
    </div>
</div>

<!-- Toast Container -->
<div class="toast-container" id="toastContainer"></div>

{% endblock %}

{% block extra_js %}
<script>
    // Interactive Grid Canvas
    document.addEventListener('DOMContentLoaded', function () {
        var canvas = document.querySelector('.apps-grid-canvas');
        if (!canvas) return;

        var ctx = canvas.getContext('2d');
        var cellSize = 60;

        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = Math.max(document.documentElement.scrollHeight, window.innerHeight);
            drawGrid();
        }

        function drawGrid(mouseX, mouseY) {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            var baseAlpha = 0.015;
            var segmentRadius = cellSize * 3.0;

            // Vertical lines
            for (var x = 0; x <= canvas.width; x += cellSize) {
                var dx = (mouseX != null) ? (x - mouseX) : null;
                var distanceFactor = 0;

                if (mouseX != null && mouseY != null) {
                    var radialDistance = Math.abs(dx);
                    distanceFactor = Math.max(0, 1 - radialDistance / (cellSize * 6));
                }

                var alpha = baseAlpha + distanceFactor * 0.04;
                ctx.strokeStyle = "rgba(255,255,255," + alpha.toFixed(3) + ")";
                ctx.beginPath();
                ctx.moveTo(x + 0.5, 0);
                ctx.lineTo(x + 0.5, canvas.height);
                ctx.stroke();

                if (mouseX != null && mouseY != null && distanceFactor > 0) {
                    var chromaIntensity = distanceFactor * 0.20;
                    if (Math.abs(dx) < cellSize * 0.5) {
                        chromaIntensity = Math.min(0.5, chromaIntensity * 2);
                    }

                    var yStart = Math.max(0, mouseY - segmentRadius);
                    var yEnd = Math.min(canvas.height, mouseY + segmentRadius);
                    var color = (dx < 0) ? "rgba(255,59,129," : "rgba(0,240,255,";
                    var grad = ctx.createLinearGradient(0, yStart, 0, yEnd);
                    var mid = Math.max(0, Math.min(1, (mouseY - yStart) / (yEnd - yStart)));
                    var maxAlpha = chromaIntensity;

                    grad.addColorStop(0.0, color + "0)");
                    if (mid - 0.15 > 0) grad.addColorStop(mid - 0.15, color + (maxAlpha * 0.3).toFixed(3) + ")");
                    if (mid - 0.05 > 0) grad.addColorStop(mid - 0.05, color + (maxAlpha * 0.8).toFixed(3) + ")");
                    grad.addColorStop(mid, color + maxAlpha.toFixed(3) + ")");
                    if (mid + 0.05 < 1) grad.addColorStop(mid + 0.05, color + (maxAlpha * 0.8).toFixed(3) + ")");
                    if (mid + 0.15 < 1) grad.addColorStop(mid + 0.15, color + (maxAlpha * 0.3).toFixed(3) + ")");
                    grad.addColorStop(1.0, color + "0)");

                    ctx.strokeStyle = grad;
                    ctx.beginPath();
                    ctx.moveTo(x + 0.5, yStart);
                    ctx.lineTo(x + 0.5, yEnd);
                    ctx.stroke();
                }
            }

            // Horizontal lines
            for (var y = 0; y <= canvas.height; y += cellSize) {
                var dy = (mouseY != null) ? (y - mouseY) : null;
                var distanceFactorY = 0;

                if (mouseX != null && mouseY != null) {
                    var radialDistanceY = Math.abs(dy);
                    distanceFactorY = Math.max(0, 1 - radialDistanceY / (cellSize * 4));
                }

                var alphaY = baseAlpha + distanceFactorY * 0.04;
                ctx.strokeStyle = "rgba(255,255,255," + alphaY.toFixed(3) + ")";
                ctx.beginPath();
                ctx.moveTo(0, y + 0.5);
                ctx.lineTo(canvas.width, y + 0.5);
                ctx.stroke();

                if (mouseX != null && mouseY != null && distanceFactorY > 0) {
                    var chromaIntensityY = distanceFactorY * 0.20;
                    if (Math.abs(dy) < cellSize * 0.5) {
                        chromaIntensityY = Math.min(0.5, chromaIntensityY * 2);
                    }

                    var xStart = Math.max(0, mouseX - segmentRadius);
                    var xEnd = Math.min(canvas.width, mouseX + segmentRadius);
                    var color = (dy < 0) ? "rgba(100,52,248," : "rgba(255,255,255,";
                    var grad = ctx.createLinearGradient(xStart, 0, xEnd, 0);
                    var mid = Math.max(0, Math.min(1, (mouseX - xStart) / (xEnd - xStart)));
                    var maxAlpha = chromaIntensityY;

                    if (dy >= 0) {
                        maxAlpha = maxAlpha * 0.5;
                    }

                    grad.addColorStop(0.0, color + "0)");
                    if (mid - 0.15 > 0) grad.addColorStop(mid - 0.15, color + (maxAlpha * 0.3).toFixed(3) + ")");
                    if (mid - 0.05 > 0) grad.addColorStop(mid - 0.05, color + (maxAlpha * 0.8).toFixed(3) + ")");
                    grad.addColorStop(mid, color + maxAlpha.toFixed(3) + ")");
                    if (mid + 0.05 < 1) grad.addColorStop(mid + 0.05, color + (maxAlpha * 0.8).toFixed(3) + ")");
                    if (mid + 0.15 < 1) grad.addColorStop(mid + 0.15, color + (maxAlpha * 0.3).toFixed(3) + ")");
                    grad.addColorStop(1.0, color + "0)");

                    ctx.strokeStyle = grad;
                    ctx.beginPath();
                    ctx.moveTo(xStart, y + 0.5);
                    ctx.lineTo(xEnd, y + 0.5);
                    ctx.stroke();
                }
            }
        }

        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        document.addEventListener('mousemove', function (e) {
            var mouseX = e.clientX;
            var mouseY = e.clientY + window.scrollY;
            drawGrid(mouseX, mouseY);
        });

        document.addEventListener('mouseleave', function () {
            drawGrid(null, null);
        });
    });

    // Tab Navigation
    function switchToTab(tabName) {
        // Update button states
        document.querySelectorAll('.tab-button').forEach(btn => {
            btn.classList.remove('active');
            if (btn.getAttribute('data-tab') === tabName) {
                btn.classList.add('active');
            }
        });

        // Update panel visibility
        document.querySelectorAll('.tab-panel').forEach(panel => panel.classList.remove('active'));
        var targetPanel = document.getElementById('tab-' + tabName);
        if (targetPanel) {
            targetPanel.classList.add('active');
        }

        // Show/hide FAB (only on overview tab)
        const fab = document.getElementById('fabButton');
        if (tabName === 'overview') {
            fab.style.display = 'flex';
        } else {
            fab.style.display = 'none';
        }
    }

    document.querySelectorAll('.tab-button').forEach(button => {
        button.addEventListener('click', function() {
            const targetTab = this.getAttribute('data-tab');
            switchToTab(targetTab);
            // Update URL hash without scrolling
            history.replaceState(null, null, '#' + targetTab);
        });
    });

    // Handle URL hash on page load (e.g., #designs, #playlists, #media, #devices)
    (function() {
        var hash = window.location.hash.replace('#', '');
        var validTabs = ['overview', 'designs', 'playlists', 'media', 'devices'];
        if (hash && validTabs.indexOf(hash) !== -1) {
            switchToTab(hash);
        }
    })();

    // Modal Functions
    function openAddDeviceModal() {
        document.getElementById('addDeviceModal').classList.add('active');
    }

    function closeAddDeviceModal() {
        document.getElementById('addDeviceModal').classList.remove('active');
        document.getElementById('deviceCodeInput').value = '';
    }

    // Close modal on overlay click
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('modal-overlay')) {
            closeAddDeviceModal();
            closeUploadMediaModal();
            closeCreateFolderModal();
        }
    });

    // Toast Notification Function
    function showToast(message, type = 'success') {
        const container = document.getElementById('toastContainer');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.innerHTML = `<div class="toast-message">${message}</div>`;

        container.appendChild(toast);

        setTimeout(() => {
            toast.style.animation = 'slideOutRight 0.3s ease-out';
            setTimeout(() => toast.remove(), 300);
        }, 4000);
    }

    // Add Device Form Submission
    document.getElementById('addDeviceForm')?.addEventListener('submit', function(e) {
        e.preventDefault();

        const codeInput = document.getElementById('deviceCodeInput');
        const submitButton = document.getElementById('submitDeviceButton');
        const code = codeInput.value.trim().toUpperCase();

        // Client-side validation
        if (code.length !== 6) {
            showToast('Registration code must be exactly 6 characters', 'error');
            return;
        }

        // Disable button and show loading state
        submitButton.disabled = true;
        submitButton.textContent = 'Registering...';

        // Make AJAX request
        fetch('/digital-signage/ajax/devices/register-with-code/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ code: code })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('Device registered successfully!', 'success');
                closeAddDeviceModal();
                // Reload page to show new device
                setTimeout(() => window.location.reload(), 1500);
            } else {
                showToast(data.error || 'Failed to register device', 'error');
                submitButton.disabled = false;
                submitButton.textContent = 'Register Device';
            }
        })
        .catch(error => {
            showToast('Network error. Please try again.', 'error');
            submitButton.disabled = false;
            submitButton.textContent = 'Register Device';
        });
    });

    // Auto-format device code input (uppercase, max 6 chars)
    document.getElementById('deviceCodeInput')?.addEventListener('input', function(e) {
        this.value = this.value.toUpperCase().substring(0, 6);
    });

    // =========================================
    // MEDIA LIBRARY FUNCTIONS
    // =========================================

    // Selected files for upload
    let selectedFiles = [];

    // Upload Media Modal Functions
    function openUploadMediaModal() {
        document.getElementById('uploadMediaModal').classList.add('active');
        selectedFiles = [];
        updateUploadPreview();
    }

    function closeUploadMediaModal() {
        document.getElementById('uploadMediaModal').classList.remove('active');
        selectedFiles = [];
        updateUploadPreview();
        document.getElementById('mediaFileInput').value = '';
    }

    // Create Folder Modal Functions
    function openCreateFolderModal() {
        document.getElementById('createFolderModal').classList.add('active');
    }

    function closeCreateFolderModal() {
        document.getElementById('createFolderModal').classList.remove('active');
        document.getElementById('createFolderForm').reset();
    }

    // Device Group Modal Functions
    function openCreateGroupModal() {
        document.getElementById('createGroupModal').classList.add('active');
    }

    function closeCreateGroupModal() {
        document.getElementById('createGroupModal').classList.remove('active');
        document.getElementById('createGroupForm').reset();
    }

    // Device Group Filter Function
    function filterDevicesByGroup(groupSlug) {
        // Update active button
        document.querySelectorAll('#tab-devices .folder-filter-btn').forEach(btn => {
            btn.classList.remove('active');
            if (btn.getAttribute('data-group') === groupSlug) {
                btn.classList.add('active');
            }
        });

        // Filter device cards
        var deviceCards = document.querySelectorAll('#devicesGrid .device-card');
        deviceCards.forEach(function(card) {
            var cardGroup = card.getAttribute('data-group') || '';
            if (groupSlug === '') {
                card.style.display = '';
            } else if (groupSlug === 'ungrouped' && cardGroup === '') {
                card.style.display = '';
            } else if (cardGroup === groupSlug) {
                card.style.display = '';
            } else {
                card.style.display = 'none';
            }
        });
    }

    // Folder Filter Function
    function filterByFolder(folderSlug) {
        // Update active button
        document.querySelectorAll('#tab-media .folder-filter-btn').forEach(btn => {
            btn.classList.remove('active');
            if (btn.getAttribute('data-folder') === folderSlug) {
                btn.classList.add('active');
            }
        });

        // Filter media cards
        const mediaCards = document.querySelectorAll('.media-card');
        mediaCards.forEach(card => {
            const cardFolder = card.getAttribute('data-folder') || '';
            if (folderSlug === '' || cardFolder === folderSlug) {
                card.style.display = '';
            } else {
                card.style.display = 'none';
            }
        });
    }

    // Upload Dropzone Handling
    const uploadDropzone = document.getElementById('uploadDropzone');
    const mediaFileInput = document.getElementById('mediaFileInput');

    if (uploadDropzone && mediaFileInput) {
        // Click to browse
        uploadDropzone.addEventListener('click', () => mediaFileInput.click());

        // Drag & drop events
        uploadDropzone.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadDropzone.classList.add('dragover');
        });

        uploadDropzone.addEventListener('dragleave', (e) => {
            e.preventDefault();
            uploadDropzone.classList.remove('dragover');
        });

        uploadDropzone.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadDropzone.classList.remove('dragover');
            handleFiles(e.dataTransfer.files);
        });

        // File input change
        mediaFileInput.addEventListener('change', (e) => {
            handleFiles(e.target.files);
        });
    }

    function handleFiles(files) {
        const allowedTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp', 'image/bmp', 'video/mp4', 'video/webm', 'video/quicktime'];
        const maxSize = 100 * 1024 * 1024; // 100MB

        for (let file of files) {
            if (!allowedTypes.includes(file.type)) {
                showToast(`${file.name}: Unsupported file type`, 'error');
                continue;
            }
            if (file.size > maxSize) {
                showToast(`${file.name}: File too large (max 100MB)`, 'error');
                continue;
            }
            // Avoid duplicates
            if (!selectedFiles.find(f => f.name === file.name && f.size === file.size)) {
                selectedFiles.push(file);
            }
        }
        updateUploadPreview();
    }

    function updateUploadPreview() {
        const previewList = document.getElementById('uploadPreviewList');
        const uploadBtn = document.getElementById('uploadSubmitBtn');

        if (selectedFiles.length === 0) {
            previewList.style.display = 'none';
            uploadBtn.disabled = true;
            uploadBtn.textContent = 'Upload Files';
            return;
        }

        previewList.style.display = 'block';
        uploadBtn.disabled = false;
        uploadBtn.textContent = `Upload ${selectedFiles.length} File${selectedFiles.length > 1 ? 's' : ''}`;

        previewList.innerHTML = selectedFiles.map((file, index) => {
            const isImage = file.type.startsWith('image/');
            const sizeStr = formatFileSize(file.size);
            let thumbHtml = '';

            if (isImage) {
                const url = URL.createObjectURL(file);
                thumbHtml = `<img src="${url}" alt="${file.name}">`;
            } else {
                thumbHtml = `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,0.5)" stroke-width="1.5"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>`;
            }

            return `
                <div class="upload-preview-item">
                    <div class="upload-preview-thumb">${thumbHtml}</div>
                    <div class="upload-preview-info">
                        <div class="upload-preview-name">${file.name}</div>
                        <div class="upload-preview-size">${sizeStr}</div>
                    </div>
                    <button type="button" class="upload-preview-remove" onclick="removeUploadFile(${index})">&times;</button>
                </div>
            `;
        }).join('');
    }

    function removeUploadFile(index) {
        selectedFiles.splice(index, 1);
        updateUploadPreview();
    }

    function formatFileSize(bytes) {
        if (bytes < 1024) return bytes + ' B';
        if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
        return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
    }

    // Upload Form Submission
    document.getElementById('uploadMediaForm')?.addEventListener('submit', function(e) {
        e.preventDefault();

        if (selectedFiles.length === 0) {
            showToast('Please select files to upload', 'error');
            return;
        }

        const submitBtn = document.getElementById('uploadSubmitBtn');
        submitBtn.disabled = true;
        submitBtn.textContent = 'Uploading...';

        const formData = new FormData();
        const folderSelect = this.querySelector('select[name="folder"]');
        if (folderSelect && folderSelect.value) {
            formData.append('folder', folderSelect.value);
        }
        selectedFiles.forEach(file => {
            formData.append('files', file);
        });

        fetch('/digital-signage/ajax/media/upload/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast(`Successfully uploaded ${data.uploaded_count} file(s)`, 'success');
                closeUploadMediaModal();
                setTimeout(() => window.location.reload(), 1500);
            } else {
                showToast(data.error || 'Upload failed', 'error');
                submitBtn.disabled = false;
                submitBtn.textContent = `Upload ${selectedFiles.length} File${selectedFiles.length > 1 ? 's' : ''}`;
            }
        })
        .catch(error => {
            showToast('Network error. Please try again.', 'error');
            submitBtn.disabled = false;
            submitBtn.textContent = `Upload ${selectedFiles.length} File${selectedFiles.length > 1 ? 's' : ''}`;
        });
    });

    // Create Folder Form Submission
    document.getElementById('createFolderForm')?.addEventListener('submit', function(e) {
        e.preventDefault();

        const nameInput = this.querySelector('input[name="name"]');
        const descInput = this.querySelector('textarea[name="description"]');
        const submitBtn = this.querySelector('button[type="submit"]');

        const name = nameInput.value.trim();
        if (!name) {
            showToast('Please enter a folder name', 'error');
            return;
        }

        submitBtn.disabled = true;
        submitBtn.textContent = 'Creating...';

        fetch('/digital-signage/ajax/folders/create/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                name: name,
                description: descInput.value.trim()
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast(`Folder "${data.folder.name}" created`, 'success');
                closeCreateFolderModal();
                setTimeout(() => window.location.reload(), 1500);
            } else {
                showToast(data.error || 'Failed to create folder', 'error');
                submitBtn.disabled = false;
                submitBtn.textContent = 'Create Folder';
            }
        })
        .catch(error => {
            showToast('Network error. Please try again.', 'error');
            submitBtn.disabled = false;
            submitBtn.textContent = 'Create Folder';
        });
    });

    // Create Device Group Form Submission
    document.getElementById('createGroupForm').addEventListener('submit', function(e) {
        e.preventDefault();

        const formData = new FormData(this);
        const name = formData.get('name').trim();
        const descInput = this.querySelector('[name="description"]');
        const addressInput = this.querySelector('[name="address"]');
        const submitBtn = this.querySelector('button[type="submit"]');

        if (!name) {
            showToast('Group name is required', 'error');
            return;
        }

        submitBtn.disabled = true;
        submitBtn.textContent = 'Creating...';

        fetch('/digital-signage/ajax/device-groups/create/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': formData.get('csrfmiddlewaretoken'),
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({
                name: name,
                description: descInput ? descInput.value.trim() : '',
                address: addressInput ? addressInput.value.trim() : ''
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast(`Group "${data.group.name}" created`, 'success');
                closeCreateGroupModal();
                setTimeout(() => window.location.reload(), 1500);
            } else {
                showToast(data.error || 'Failed to create group', 'error');
                submitBtn.disabled = false;
                submitBtn.textContent = 'Create Group';
            }
        })
        .catch(error => {
            showToast('Network error. Please try again.', 'error');
            submitBtn.disabled = false;
            submitBtn.textContent = 'Create Group';
        });
    });

    // =========================================================================
    // Media Detail Modal Functions
    // =========================================================================
    var currentMediaId = null;

    // Update media stats after add/delete
    function updateMediaStats(delta) {
        // Update total count
        var statCards = document.querySelectorAll('#tab-media .stat-card');
        if (statCards.length > 0) {
            var totalValue = statCards[0].querySelector('.stat-value');
            if (totalValue) {
                var count = parseInt(totalValue.textContent) + delta;
                totalValue.textContent = count >= 0 ? count : 0;
            }
        }
        // Check if grid is empty and show empty state
        var mediaGrid = document.querySelector('#tab-media .media-grid');
        var emptyState = document.querySelector('#tab-media .empty-state');
        if (mediaGrid) {
            var remainingCards = mediaGrid.querySelectorAll('.media-card');
            if (remainingCards.length === 0 && !emptyState) {
                // Hide grid and show empty state
                mediaGrid.style.display = 'none';
                var newEmptyState = document.createElement('div');
                newEmptyState.className = 'empty-state';
                newEmptyState.innerHTML = '<h3>No media uploaded yet</h3><p>Upload images and videos to use in your playlists.</p><button class="btn-primary-grid" style="margin-top: 1rem;" onclick="openUploadMediaModal()">+ Upload First Media</button>';
                mediaGrid.parentNode.appendChild(newEmptyState);
            }
        }
    }

    function openMediaDetailModal(assetId) {
        currentMediaId = assetId;
        var modal = document.getElementById('mediaDetailModal');
        var content = document.getElementById('mediaDetailContent');
        var loading = document.getElementById('mediaDetailLoading');

        // Show modal with loading state
        modal.classList.add('active');
        content.style.display = 'none';
        loading.style.display = 'block';

        // Fetch media details
        fetch('/digital-signage/ajax/media/' + assetId + '/', {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(function(response) { return response.json(); })
        .then(function(data) {
            if (data.success) {
                var asset = data.asset;

                // Update title
                document.getElementById('mediaDetailTitle').textContent = asset.name;

                // Update preview
                var imgPreview = document.getElementById('mediaPreviewImage');
                var videoPreview = document.getElementById('mediaPreviewVideo');

                if (asset.asset_type === 'image') {
                    imgPreview.src = asset.file_url;
                    imgPreview.style.display = 'block';
                    videoPreview.style.display = 'none';
                } else {
                    videoPreview.src = asset.file_url;
                    videoPreview.style.display = 'block';
                    imgPreview.style.display = 'none';
                }

                // Update info
                document.getElementById('mediaDetailType').textContent = asset.asset_type.charAt(0).toUpperCase() + asset.asset_type.slice(1);
                document.getElementById('mediaDetailSize').textContent = asset.file_size_display;

                // Update editable fields
                document.getElementById('mediaDetailName').value = asset.name;
                document.getElementById('mediaDetailFolder').value = asset.folder_id || '';

                // Show content
                loading.style.display = 'none';
                content.style.display = 'block';
            } else {
                showToast(data.error || 'Failed to load media details', 'error');
                closeMediaDetailModal();
            }
        })
        .catch(function(error) {
            console.error('Error:', error);
            showToast('Failed to load media details', 'error');
            closeMediaDetailModal();
        });
    }

    function closeMediaDetailModal() {
        var modal = document.getElementById('mediaDetailModal');
        modal.classList.remove('active');

        // Stop video playback
        var videoPreview = document.getElementById('mediaPreviewVideo');
        videoPreview.pause();
        videoPreview.src = '';

        currentMediaId = null;
    }

    function saveMediaChanges() {
        if (!currentMediaId) return;

        var name = document.getElementById('mediaDetailName').value.trim();
        var folderId = document.getElementById('mediaDetailFolder').value;

        fetch('/digital-signage/ajax/media/' + currentMediaId + '/update/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({
                name: name,
                folder_id: folderId || null
            })
        })
        .then(function(response) { return response.json(); })
        .then(function(data) {
            if (data.success) {
                showToast('Media updated successfully', 'success');
                closeMediaDetailModal();
                // Update the media card in place without full reload
                var card = document.querySelector('[data-asset-id="' + currentMediaId + '"]');
                if (card) {
                    var nameEl = card.querySelector('.media-name');
                    if (nameEl) nameEl.textContent = name;
                    // Update folder data attribute (use slug for filtering)
                    card.dataset.folder = data.asset.folder_slug || 'uncategorized';
                }
            } else {
                showToast(data.error || 'Failed to update media', 'error');
            }
        })
        .catch(function(error) {
            console.error('Error:', error);
            showToast('Failed to update media', 'error');
        });
    }

    function confirmDeleteMedia() {
        var name = document.getElementById('mediaDetailName').value;
        document.getElementById('deleteMediaName').textContent = name;
        // Reset error state
        document.getElementById('deleteMediaError').style.display = 'none';
        document.getElementById('deleteMediaError').textContent = '';
        document.getElementById('deleteMediaBtn').disabled = false;
        document.getElementById('deleteMediaModal').classList.add('active');
    }

    function closeDeleteMediaModal() {
        document.getElementById('deleteMediaModal').classList.remove('active');
        // Reset error state when closing
        document.getElementById('deleteMediaError').style.display = 'none';
        document.getElementById('deleteMediaError').textContent = '';
    }

    function executeDeleteMedia() {
        if (!currentMediaId) return;

        // Save the ID before async operations (closeMediaDetailModal resets it)
        var mediaIdToDelete = currentMediaId;

        // Use POST method instead of DELETE for better CSRF compatibility
        fetch('/digital-signage/ajax/media/' + mediaIdToDelete + '/delete/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({})
        })
        .then(function(response) {
            return response.json().then(function(data) {
                return { ok: response.ok, data: data };
            });
        })
        .then(function(result) {
            if (result.ok && result.data.success) {
                showToast(result.data.message, 'success');
                closeDeleteMediaModal();
                closeMediaDetailModal();
                // Remove the media card from the grid (use saved ID)
                var card = document.querySelector('[data-asset-id="' + mediaIdToDelete + '"]');
                if (card) {
                    card.remove();
                }
                // Update media stats
                updateMediaStats(-1);
            } else {
                // Show error message in the modal
                var errorMsg = result.data.error || 'Failed to delete media';
                console.log('Cannot delete media:', errorMsg);
                var errorDiv = document.getElementById('deleteMediaError');
                errorDiv.textContent = errorMsg;
                errorDiv.style.display = 'block';
                // Disable delete button to prevent repeated attempts
                document.getElementById('deleteMediaBtn').disabled = true;
            }
        })
        .catch(function(error) {
            console.error('Delete media network error:', error);
            var errorDiv = document.getElementById('deleteMediaError');
            errorDiv.textContent = 'Network error. Please try again.';
            errorDiv.style.display = 'block';
        });
    }

    // Close modals when clicking outside
    document.getElementById('mediaDetailModal').addEventListener('click', function(e) {
        if (e.target === this) closeMediaDetailModal();
    });
    document.getElementById('deleteMediaModal').addEventListener('click', function(e) {
        if (e.target === this) closeDeleteMediaModal();
    });

    // =========================================================================
    // DRAG AND DROP FOR DEVICE GROUPS
    // =========================================================================
    var isDragging = false;
    var draggedDevice = null;

    function initDragAndDrop() {
        // Get all draggable device cards
        var draggableDevices = document.querySelectorAll('.draggable-device');
        var dropzones = document.querySelectorAll('.device-dropzone');

        // Add drag events to each device card
        draggableDevices.forEach(function(device) {
            device.addEventListener('dragstart', handleDragStart);
            device.addEventListener('dragend', handleDragEnd);
        });

        // Add drop events to each dropzone
        dropzones.forEach(function(dropzone) {
            dropzone.addEventListener('dragover', handleDragOver);
            dropzone.addEventListener('dragenter', handleDragEnter);
            dropzone.addEventListener('dragleave', handleDragLeave);
            dropzone.addEventListener('drop', handleDrop);
        });
    }

    function handleDragStart(e) {
        isDragging = true;
        draggedDevice = this;
        this.classList.add('dragging');

        // Set drag data
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/plain', this.dataset.deviceId);

        // Add visual feedback after a small delay
        setTimeout(function() {
            draggedDevice.style.opacity = '0.5';
        }, 0);
    }

    function handleDragEnd(e) {
        isDragging = false;
        this.classList.remove('dragging');
        this.style.opacity = '1';
        draggedDevice = null;

        // Remove drag-over class from all dropzones
        document.querySelectorAll('.device-dropzone').forEach(function(dz) {
            dz.classList.remove('drag-over');
        });
    }

    function handleDragOver(e) {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
        return false;
    }

    function handleDragEnter(e) {
        e.preventDefault();
        this.classList.add('drag-over');
    }

    function handleDragLeave(e) {
        // Only remove if we're leaving the dropzone itself, not entering a child
        if (e.target === this) {
            this.classList.remove('drag-over');
        }
    }

    function handleDrop(e) {
        e.preventDefault();
        e.stopPropagation();

        this.classList.remove('drag-over');

        if (!draggedDevice) return;

        var deviceId = e.dataTransfer.getData('text/plain');
        var newGroupId = this.dataset.groupId;
        var oldGroupId = draggedDevice.closest('.device-group-section').dataset.groupId;

        // Don't do anything if dropped in the same group
        if (newGroupId === oldGroupId) return;

        // Move the card visually first for instant feedback
        var placeholder = this.querySelector('.dropzone-placeholder');
        if (placeholder) {
            placeholder.remove();
        }
        this.appendChild(draggedDevice);

        // Check if old dropzone is now empty and add placeholder
        var oldDropzone = document.querySelector('.device-group-section[data-group-id="' + oldGroupId + '"] .device-dropzone');
        if (oldDropzone && oldDropzone.querySelectorAll('.draggable-device').length === 0) {
            var newPlaceholder = document.createElement('div');
            newPlaceholder.className = 'dropzone-placeholder';
            newPlaceholder.textContent = 'Drop devices here';
            oldDropzone.appendChild(newPlaceholder);
        }

        // Update device group counts
        updateGroupCounts();

        // Send AJAX request to update the database
        fetch('/digital-signage/ajax/devices/' + deviceId + '/update-group/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({
                group_id: newGroupId || null
            })
        })
        .then(function(response) { return response.json(); })
        .then(function(data) {
            if (data.success) {
                showToast('Device moved successfully', 'success');
            } else {
                showToast(data.error || 'Failed to move device', 'error');
                // Revert the visual change on error
                window.location.reload();
            }
        })
        .catch(function(error) {
            console.error('Error:', error);
            showToast('Failed to move device', 'error');
            // Revert the visual change on error
            window.location.reload();
        });
    }

    function updateGroupCounts() {
        // Update device count for each group section
        document.querySelectorAll('.device-group-section').forEach(function(section) {
            var dropzone = section.querySelector('.device-dropzone');
            var countEl = section.querySelector('.device-group-count');
            if (dropzone && countEl) {
                var deviceCount = dropzone.querySelectorAll('.draggable-device').length;
                countEl.textContent = deviceCount + ' device' + (deviceCount !== 1 ? 's' : '');
            }
        });
    }

    // Initialize drag and drop when DOM is ready
    document.addEventListener('DOMContentLoaded', initDragAndDrop);
</script>
{% endblock %}
